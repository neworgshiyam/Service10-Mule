name: Mulesoft - Build

on: 
  workflow_dispatch:

env:
    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
             
jobs:

  Pre-Build:
    runs-on: ubuntu-latest
    steps:
      - name: Versioning 
        run: |
            echo setting release version!!
            Version="23.03.01.${{ github.run_number }}"
            echo $Version
            
  Build:

       needs: [Pre-Build]
       runs-on: ubuntu-latest
       steps:
          - uses: actions/checkout@v2
          
          - name: Build with Maven
            run: mvn versions:set -DnewVersion=${{needs.Pre-Release.outputs.currentversion}}
            
          - name: Sonar Analysis
            run: mvn -B verify sonar:sonar -DnewVersion=${{needs.Pre-Release.outputs.currentversion}} -Dsonar.projectKey=shiyamsundark_Customer-service-accounts -Dsonar.organization=shiyamsundark -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$SONAR_TOKEN
                             
                     
  Publish:
        needs: [Build,Pre-Build]
        runs-on: ubuntu-latest
        
        permissions:
          contents: read
          packages: write
          
        steps:
        
          - uses: actions/checkout@v2 
          
          - uses: actions/setup-java@v3
            with:
              java-version: '11'
              distribution: 'temurin'
              server-id: github 
              settings-path: ${{ github.workspace }} 
              
          - name: Publish to GitHub Packages Apache Maven
            run: mvn deploy -DnewVersion=${{needs.Pre-Release.outputs.currentversion}} -s $GITHUB_WORKSPACE/settings.xml
            env:
             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
             
             
